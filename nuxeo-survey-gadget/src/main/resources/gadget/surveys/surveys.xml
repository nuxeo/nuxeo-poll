<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="Nuxeo Surveys"
    description=""
    author="troger" author_email="troger@nuxeo.com" height="280">
    <#include "dynamic-translations.ftl"/>
    <Require feature="dynamic-height" />
    <#include "default-oauth-prefs.ftl"/>
  </ModulePrefs>
  <UserPref name="surveyId" datatype="hidden" default_value="" />
  <UserPref name="displayResult" datatype="hidden" default_value="false" />
  <Content type="html">

<![CDATA[
<html>
  <head>
  <link rel="stylesheet" type="text/css" href="${specDirectoryUrl}gadget-common.css"/>
  <link rel="stylesheet" type="text/css" href="surveys.css"/>

  <!-- insert JS Context -->
  ${jsContext}

  <script src="${specDirectoryUrl}default-automation-request.js"></script>
  <script src="${clientSideBaseUrl}nxthemes-lib/jquery.js"></script>
  <script src="${clientSideBaseUrl}scripts/jquery/flot/jquery.flot.min.js"></script>
  <script src="${clientSideBaseUrl}scripts/jquery/flot/jquery.flot.pie.min.js"></script>

  <script>
    var prefs = new gadgets.Prefs();

    var surveys = [];
    var currentSurveyIndex = 0;

    function storeSurveys(response, params) {
      surveys = response.data.surveys;

      currentSurveyIndex = 0;
      if (surveys.length > 0) {
        displayCurrentSurvey();
      } else {
        displayNoSurvey();
      }
    }

    function displayCurrentSurvey() {
      displaySurvey(surveys[currentSurveyIndex]);
    }

    function displaySurvey(survey, forceResultDisplay, hideNavigationBar) {
      if (typeof forceResultDisplay === 'undefined') {
        forceResultDisplay = 'false';
      }
      if (typeof hideNavigationBar === 'undefined') {
        hideNavigationBar = false;
      }

      emptyAndHideEverything();
      jQuery('#surveyQuestion').html(survey.question);
      if ((forceResultDisplay === 'true') || survey.answered) {
        displaySurveyResultsHtml(survey);
      } else {
        displaySurveyQuestionHtml(survey);
      }

      if (hideNavigationBar != true) {
        // create the navigation bar
        createNavigationBar();
      }

      gadgets.window.adjustHeight();
    }

    function emptyAndHideEverything() {
      jQuery('.tools').empty();
      jQuery('.tools').hide();
      jQuery('#surveyQuestion').empty();
      jQuery('#survey').empty();
      jQuery('#surveyResult').empty();
      jQuery('#surveyResult').hide();
      jQuery('#legend').empty();
      jQuery('#legend').hide();
      jQuery('#totalVotes').empty();
      jQuery('#totalVotes').hide();
    }

    function displaySurveyQuestionHtml(survey) {
      var surveyHtml = '<div class="answers">';
      surveyHtml += '<ul>'
      for (var i = 0; i < survey.answers.length; i++) {
        surveyHtml += '<li>';
        surveyHtml += '<input type="radio" name="answers" value="' + i + '"';
        if (i == 0) {
          surveyHtml += ' checked="checked"';
        }
        surveyHtml += '>' + survey.answers[i];
        surveyHtml += '</li>';
      }
      surveyHtml += '</ul>';
      surveyHtml += '</div>';
      surveyHtml += '<p><a class="answerButton" href="javascript:answerSurvey()">' + prefs.getMsg('command.cast.vote') + '</a></p>';

      jQuery('#survey').html(surveyHtml);
    }

    function displaySurveyResultsHtml(survey) {
      buildAndDisplayToolbar();
      buildAndDisplayChart('pie', survey);
      buildAndDisplayTotalVotes(survey);
    }

    function buildAndDisplayToolbar() {
      var toolbarHtml = '';
      toolbarHtml += '<select name="chartType" id="chartType">';
      toolbarHtml += '<option value="pie">' + prefs.getMsg('label.survey.chart.type.pie') + '</option>'
      toolbarHtml += '<option value="bars">' + prefs.getMsg('label.survey.chart.type.bars') + '</option>'
      toolbarHtml += '</select>';

      jQuery('.tools').html(toolbarHtml);
      jQuery('.tools').show();

      jQuery("#chartType").change(function () {
        var chartType = jQuery('#chartType option:selected').val();
        buildAndDisplayChart(chartType);
      });
    }

    function buildAndDisplayChart(chartType, survey) {
      chartType = chartType || 'pie';
      survey = survey || surveys[currentSurveyIndex];

      if (chartType == 'pie') {
        var data = [];
        var resultsByAnswer = survey.result.resultsByAnswer;
        for( var i = 0; i < resultsByAnswer.length; i++) {
          var label = generateLabel(resultsByAnswer[i].answer, resultsByAnswer[i].result, survey.result.resultsCount);
          data[i] = { label: label, data: resultsByAnswer[i].result }
        }

        jQuery.plot(jQuery("#surveyResult"), data, {
            legend: {
              container: jQuery('#legend')
            },
            series: {
              pie: {
                show: true
              }
            }
        });
      } else if (chartType == 'bars') {
        var data = [];
        var resultsByAnswer = survey.result.resultsByAnswer;
        for( var i = 0; i < resultsByAnswer.length; i++) {
          var label = generateLabel(resultsByAnswer[i].answer, resultsByAnswer[i].result, survey.result.resultsCount);
          data[i] = { label: label, data: [[i, resultsByAnswer[i].result]] };
        }

        jQuery.plot(jQuery("#surveyResult"), data, {
          legend: {
            show: true,
            margin: 10,
            backgroundOpacity: 0.5,
            container: jQuery('#legend')
          },
          series: {
            bars: {
              show: true
            }
          },
          xaxis: {
            min: 0,
            tickSize: 1,
            tickFormatter: function (v) { return ""; }
          },
          yaxis: {
            min: 0,
            tickDecimals: 0
          }
        });
      }

      jQuery('#surveyResult').show();
      jQuery('#legend').show();
    }

    function generateLabel(answer, result, resultsCount) {
      var label = '(0%)';
      if (!isNaN(result / resultsCount)) {
        label = answer + ' (' + (result / resultsCount) * 100 + '%)';
      }
      return label;
    }

    function buildAndDisplayTotalVotes(survey) {
      var totalVotes = prefs.getMsg('label.survey.total.votes') + ' ' + survey.result.resultsCount;
      jQuery('#totalVotes').html(totalVotes).show();
    }

    function createNavigationBar() {
      if (surveys.length <= 0) {
        return;
      }

      var htmlContent = '';
      if (currentSurveyIndex > 0) {
        htmlContent += '<span class="previousButton"><a href="javascript:previousSurvey()">' + prefs.getMsg('command.previous.survey') + '</a></span>';
      } else {
        htmlContent += '<span class="previousButton">' + prefs.getMsg('command.previous.survey') + '</span>';
      }
      htmlContent += '<span class="surveysInfo">' + surveys.length + ' ' + prefs.getMsg('label.surveys') + '</span>';
      if (currentSurveyIndex < surveys.length - 1) {
        htmlContent += '<span class="nextButton"><a href="javascript:nextSurvey()">' + prefs.getMsg('command.next.survey') + '</a></span>';
      } else {
        htmlContent += '<span class="nextButton">' + prefs.getMsg('command.next.survey') + '</span>';
      }

      jQuery('.navigationBar').html(htmlContent);
    }

    function previousSurvey() {
      currentSurveyIndex -= 1;
      displayCurrentSurvey();
    }

    function nextSurvey() {
      currentSurveyIndex += 1;
      displayCurrentSurvey();
    }

    function displayNoSurvey() {
      emptyAndHideEverything();
      jQuery('#noSurveyLabel').html(prefs.getMsg('label.no.open.survey'));
      gadgets.window.adjustHeight();
    }

    function answerSurvey() {
      var answerIndex = jQuery('input[name=answers]:checked').val();
      if (answerIndex >= 0) {
        var answerRequestParams = { operationId : 'Services.AnswerSurvey',
          operationParams: {
            surveyId: surveys[currentSurveyIndex].surveyId,
            answerIndex: answerIndex
          },
          operationContext: {},
          operationCallback: afterAnswerSurvey
        };
        doAutomationRequest(answerRequestParams);
      }
    }

    function afterAnswerSurvey(response, params) {
      var survey = response.data;
      // find the survey index
      for (var i = 0; i < surveys.length; ++i) {
        if (surveys[i].surveyId == survey.surveyId) {
          currentSurveyIndex = i;
          surveys[i] = survey;
          break;
        }
      }
      displaySurvey(survey);
    }

    gadgets.util.registerOnLoadHandler(function() {
      var surveyId = prefs.getString("surveyId");
      if (surveyId != "") {
        loadOneSurvey(surveyId);
      } else {
        loadOpenSurveys();
      }

    });

    function loadOpenSurveys() {
      var NXRequestParams= { operationId : 'Services.GetOpenSurveys',
        operationParams: {
          onlyUnansweredSurveys: true
        },
        operationContext: {},
        operationCallback: storeSurveys
      };

      doAutomationRequest(NXRequestParams);
    }

    function loadOneSurvey(surveyId) {
      var NXRequestParams= { operationId : 'Services.GetSurvey',
        operationParams: {
          surveyId: surveyId,
          withResult: true
        },
        operationContext: {},
        operationCallback: function(response, params) {
          var survey = response.data;
          currentSurveyIndex = 0;
          surveys = [survey];
          displaySurvey(survey, prefs.getString("displayResult"), true);
        }
      };

      doAutomationRequest(NXRequestParams);
    }

  </script>
  </head>
  <body>

    <#include "default-request-controls.ftl"/>

    <div class="tools"></div>
    <div id="noSurveyLabel"></div>

    <div id="content">

      <h4 id="surveyQuestion"></h4>
      <div id="survey">
      </div>
      <div id="surveyResult" style="width: 180px; height: 150px;">
      </div>
      <div id="legend">
      </div>
      <div id="totalVotes">
      </div>

      <div class="navigationBar">
      </div>
      <div style="clear:both;"></div>
    </div>

  </body>
</html>
]]>
  </Content>
</Module>
