<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="Nuxeo Surveys"
    description=""
    author="troger" author_email="troger@nuxeo.com">
    <#include "dynamic-translations.ftl"/>
    <Require feature="dynamic-height" />
    <#include "default-oauth-prefs.ftl"/>
  </ModulePrefs>
  <UserPref name="surveyId" datatype="hidden" default_value="" />
  <UserPref name="displayResult" datatype="hidden" default_value="false" />
  <Content type="html">

<![CDATA[
<html>
  <head>
  <link rel="stylesheet" type="text/css" href="${specDirectoryUrl}gadget-common.css"/>

  <!-- insert JS Context -->
  ${jsContext}

  <script src="${specDirectoryUrl}default-automation-request.js"></script>
  <script src="${clientSideBaseUrl}site/skin/base/script/jquery/jquery.js"></script>
  <script src="${clientSideBaseUrl}site/skin/base/script/jquery/flot/jquery.flot.min.js"></script>
  <script src="${clientSideBaseUrl}site/skin/base/script/jquery/flot/jquery.flot.pie.min.js"></script>

  <script>
    var prefs = new gadgets.Prefs();

    var surveys = [];
    var currentSurveyIndex = 0;

    function storeSurveys(response, params) {
      surveys = response.data.surveys;

      currentSurveyIndex = 0;
      if (surveys.length > 0) {
        displayCurrentSurvey();
      } else {
        displayNoSurvey();
      }
    }

    function displayCurrentSurvey() {
      displaySurvey(surveys[currentSurveyIndex]);
    }

    function displaySurvey(survey, forceResultDisplay, hideNavigationBar) {
      if (typeof forceResultDisplay === 'undefined') {
        forceResultDisplay = 'false';
      }
      if (typeof hideNavigationBar === 'undefined') {
        hideNavigationBar = false;
      }
      $('#surveyQuestion').empty();
      $('#survey').empty();
      $('#surveyResult').empty();
      $('.tools').empty();

      $('#surveyQuestion').html(survey.question);
      if ((forceResultDisplay === 'true') || survey.answered) {
        displaySurveyResultsHtml(survey);
      } else {
        displaySurveyQuestionHtml(survey);
      }

      if (hideNavigationBar != true) {
        // create the navigation bar
        createNavigationBar();
      }

      gadgets.window.adjustHeight();
    }

    function displaySurveyQuestionHtml(survey) {
      var surveyHtml = '<div class="answers">';
      surveyHtml += '<ul>'
      for (var i = 0; i < survey.answers.length; i++) {
        surveyHtml += '<li>';
        surveyHtml += '<input type="radio" name="answers" value="' + i + '"';
        if (i == 0) {
          surveyHtml += ' checked="checked"';
        }
        surveyHtml += '>' + survey.answers[i];
        surveyHtml += '</li>';
      }
      surveyHtml += '</ul>';
      surveyHtml += '</div>';
      surveyHtml += '<p><a class="answerButton" href="javascript:answerSurvey()">' + prefs.getMsg('command.answer.survey') + '</a></p>';

      $('#survey').html(surveyHtml);
    }

    function displaySurveyResultsHtml(survey) {
      buildAndDisplayToolbar();
      buildChart('pie', survey);
    }

    function buildAndDisplayToolbar() {
      var toolbarHtml = '';
      toolbarHtml += '<select name="chartType" id="chartType">';
      toolbarHtml += '<option value="pie">' + prefs.getMsg('label.survey.chart.type.pie') + '</option>'
      toolbarHtml += '<option value="bars">' + prefs.getMsg('label.survey.chart.type.bars') + '</option>'
      toolbarHtml += '</select>';

      $('.tools').html(toolbarHtml);

      $("#chartType").change(function () {
        var chartType = $('#chartType option:selected').val();
        buildChart(chartType);
      });

      $('.tools').show();
    }

    function buildChart(chartType, survey) {
      chartType = chartType || 'pie';
      survey = survey || surveys[currentSurveyIndex];

      var data = [];
      var resultsByAnswer = survey.result.resultsByAnswer;
      for( var i = 0; i < resultsByAnswer.length; i++) {
        data[i] = { label: resultsByAnswer[i].answer, data: resultsByAnswer[i].result }
      }

      if (chartType == 'pie') {
        var data = [];
        var resultsByAnswer = survey.result.resultsByAnswer;
        for( var i = 0; i < resultsByAnswer.length; i++) {
          data[i] = { label: resultsByAnswer[i].answer, data: resultsByAnswer[i].result }
        }

        $.plot($("#surveyResult"), data, {
            series: {
              pie: {
                show: true
              }
            }
        });
      } else if (chartType == 'bars') {

        var data = [{label: "yo", data: [[0, 145]]}, {label:"tada", data:[[1, 1000]]}];

        var data = [];
        var resultsByAnswer = survey.result.resultsByAnswer;
        for( var i = 0; i < resultsByAnswer.length; i++) {
          data[i] = { label: survey.answers[i], data: [[i, resultsByAnswer[i].result]] };
        }

        $.plot($("#surveyResult"), data, {
          legend: {
            show: true,
            margin: 10,
            backgroundOpacity: 0.5
          },
          series: {
            bars: { show: true }
          },
          xaxis: {
            min: 0,
            tickSize: 1,
            tickFormatter: function (v) { return ""; }
          },
          yaxis: {
            min: 0,
            tickDecimals: 0
          }
        });
      }
    }

    function createNavigationBar() {
      if (surveys.length <= 0) {
        return;
      }

      var htmlContent = '';
      if (currentSurveyIndex > 0) {
        htmlContent += '<span class="previousButton"><a href="javascript:previousSurvey()">' + prefs.getMsg('command.previous.survey') + '</a></span>';
      } else {
        htmlContent += '<span class="previousButton">' + prefs.getMsg('command.previous.survey') + '</span>';
      }
      htmlContent += '<span class="surveysInfo">' + surveys.length + ' ' + prefs.getMsg('label.surveys') + '</span>';
      if (currentSurveyIndex < surveys.length - 1) {
        htmlContent += '<span class="nextButton"><a href="javascript:nextSurvey()">' + prefs.getMsg('command.next.survey') + '</a></span>';
      } else {
        htmlContent += '<span class="nextButton">' + prefs.getMsg('command.next.survey') + '</span>';
      }

      $('.navigationBar').html(htmlContent);
    }

    function previousSurvey() {
      currentSurveyIndex -= 1;
      displayCurrentSurvey();
    }

    function nextSurvey() {
      currentSurveyIndex += 1;
      displayCurrentSurvey();
    }

    function displayNoSurvey() {
      var htmlContent = '<p class="noSurveyLabel">' + prefs.getMsg('label.no.survey.published') + '</p>';
      $('#surveyQuestion').html(htmlContent);
    }

    function answerSurvey() {
      var answerIndex = $('input[name=answers]:checked').val();
      if (answerIndex >= 0) {
        var answerRequestParams = { operationId : 'Services.AnswerSurvey',
          operationParams: {
            surveyId: surveys[currentSurveyIndex].surveyId,
            answerIndex: answerIndex
          },
          operationContext: {},
          operationCallback: afterAnswerSurvey
        };
        doAutomationRequest(answerRequestParams);
      }
    }

    function afterAnswerSurvey(response, params) {
      var survey = response.data;
      // find the survey index
      for (var i = 0; i < surveys.length; ++i) {
        if (surveys[i].surveyId == survey.surveyId) {
          currentSurveyIndex = i;
          surveys[i] = survey;
          break;
        }
      }
      displaySurvey(survey);
    }

    gadgets.util.registerOnLoadHandler(function() {
      var surveyId = prefs.getString("surveyId");
      if (surveyId != "") {
        loadOneSurvey(surveyId);
      } else {
        loadPublishedSurveys();
      }

    });

    function loadPublishedSurveys() {
      var NXRequestParams= { operationId : 'Services.GetPublishedSurveys',
        operationParams: {
          onlyUnansweredSurveys: true
        },
        operationContext: {},
        operationCallback: storeSurveys
      };

      doAutomationRequest(NXRequestParams);
    }

    function loadOneSurvey(surveyId) {
      var NXRequestParams= { operationId : 'Services.GetSurvey',
        operationParams: {
          surveyId: surveyId,
          withResult: true
        },
        operationContext: {},
        operationCallback: function(response, params) {
          var survey = response.data;
          currentSurveyIndex = 0;
          surveys = [survey];
          displaySurvey(survey, prefs.getString("displayResult"), true);
        }
      };

      doAutomationRequest(NXRequestParams);
    }

  </script>
  </head>
  <body>

    <div class="tools"></div>

    <div id="content">
      <h4 id="surveyQuestion"></h4>
      <div id="survey">
      </div>
      <div id="surveyResult" style="width: 250px; height: 250px;">
      </div>

      <div class="navigationBar">
      </div>
      <#include "default-request-controls.ftl"/>
    </div>

  </body>
</html>
]]>
  </Content>
</Module>
